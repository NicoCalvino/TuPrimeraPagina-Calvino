{% extends 'kiosco/index.html' %}

{% block titulo %}<title>Kiosco Sole - Nuevo Producto</title> {% endblock %}

{% block Bienvenida %} {% endblock %}

{% block content %}
<div class="container my-5">

    <!-- Encabezado: Título y Botón Volver -->
    <div class="row justify-content-center mb-4">
        <div class="col-lg-8 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-0" style="color: #333;">✨ Nuevo Producto</h2>
                <p class="text-muted mb-0">Ingresa los datos para dar de alta un artículo.</p>
            </div>
            <a href="{% url 'lista_productos' %}" class="btn btn-outline-secondary rounded-pill px-4">
                <i class="bi bi-arrow-left"></i> Cancelar
            </a>
        </div>
    </div>

    <!-- Card del Formulario -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 p-4" style="background-color: #fff;">
                
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Fila 1: Nombre del Producto -->
                    <div class="mb-4">
                        <label for="{{ form.nombre.id_for_label }}" class="form-label fw-bold text-dark">Nombre del Producto</label>
                        {{ form.nombre }}
                        {% if form.nombre.errors %}
                            <div class="text-danger small mt-1">{{ form.nombre.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Fila 2: Marca y Categoría -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="{{ form.marca.id_for_label }}" class="form-label fw-bold text-dark">Marca</label>
                            {{ form.marca }}
                            {% if form.marca.errors %}
                                <div class="text-danger small mt-1">{{ form.marca.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.categoria.id_for_label }}" class="form-label fw-bold text-dark">Categoría</label>
                            {{ form.categoria }}
                            {% if form.categoria.errors %}
                                <div class="text-danger small mt-1">{{ form.categoria.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Fila 3: Precio, Stock y Código -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="{{ form.precio.id_for_label }}" class="form-label fw-bold text-dark">Precio</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-currency-dollar"></i></span>
                                {{ form.precio }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.stock.id_for_label }}" class="form-label fw-bold text-dark">Stock Inicial</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-box-seam"></i></span>
                                {{ form.stock }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.codigo_de_barras.id_for_label }}" class="form-label fw-bold text-dark">Código de Barras</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-upc-scan"></i></span>
                                {{ form.codigo_de_barras }}
                            </div>
                        </div>
                    </div>

                    <!-- SECCIÓN DEL AVATAR (MODIFICADA) -->
                    <div class="text-center mb-5">
                        <label class="fw-bold d-block small text-uppercase text-muted mb-3">Imagen del Producto</label>
                        
                        <div class="position-relative d-inline-block">
                            
                            <!-- 1. La imagen de previsualización (Placeholder o Foto cargada) -->
                            <!-- Si estás editando y ya hay foto, se muestra esa url, sino un placeholder -->
                            <img id="imagenPrevisualizacion" 
                                 src="{% if form.instance.picture %}{{ form.instance.picture.url }}{% else %}/media/default/producto.jpg{% endif %}" 
                                 alt="Vista previa" 
                                 class="rounded-4 shadow-sm border"
                                 style="width: 200px; height: 200px; object-fit: cover; background-color: #f8f9fa;">

                            <!-- 2. Botón flotante que activa el input -->
                            <label for="{{ form.picture.id_for_label }}" class="btn btn-warning btn-sm position-absolute bottom-0 end-0 rounded-circle shadow" style="transform: translate(25%, 25%); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-camera-fill fs-5"></i>
                            </label>

                        </div>

                        <!-- 3. El input real (Oculto visualmente o debajo, el botón de arriba lo controla) -->
                        <div class="mt-3 d-none"> <!-- d-none para ocultar el input feo y usar solo el botón -->
                            {{ form.picture }}
                        </div>
                        <!-- Mensaje de ayuda opcional -->
                        <div class="text-muted small mt-2">Haz clic en la cámara para subir una foto</div>
                    </div>

                    <hr class="my-4">

                    <!-- Botón de Guardar -->
                    <!-- Botones de Acción -->
                    <div class="row g-2">
                        <div class="col-md-6">
                            <button type="submit" name="_save" class="btn btn-warning btn-lg w-100 rounded-pill fw-bold text-dark shadow-sm">
                                <i class="bi bi-check-circle-fill me-2"></i>Guardar y Volver
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" name="_addanother" class="btn btn-outline-warning btn-lg w-100 rounded-pill fw-bold text-dark shadow-sm">
                                <i class="bi bi-plus-circle-fill me-2"></i>Guardar y Crear Otro
                            </button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPT JAVASCRIPT PARA LA PREVISUALIZACIÓN -->
<script>
    // Esperamos a que el DOM cargue
    document.addEventListener("DOMContentLoaded", function() {
        // Obtenemos el input de archivo generado por Django (generalmente id_picture)
        const inputImagen = document.getElementById("{{ form.picture.auto_id }}");
        const imagenPrevisualizacion = document.getElementById("imagenPrevisualizacion");

        if (inputImagen) {
            inputImagen.addEventListener("change", function(evento) {
                const archivo = evento.target.files[0];

                if (archivo) {
                    const lector = new FileReader();

                    lector.onload = function(e) {
                        // Asignamos el resultado (la imagen en base64) al src de la etiqueta img
                        imagenPrevisualizacion.src = e.target.result;
                    }

                    // Leemos el archivo como URL de datos
                    lector.readAsDataURL(archivo);
                }
            });
        }
    });
</script>

{% endblock %}